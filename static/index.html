<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Colors</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <div class="cycler">
        <a href="#" class="0"><span>&#x1F308;</span></a>
        <input type="range" min="0" max="40" value="10">
    </div>
    <div class="color-picker"></div>
    <div class="camera"></div>
    <div class="camera-area"></div>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="camera.js"></script>
    <script src="colorpicker.js"></script>
    <script src="cyclers.js"></script>
    <script>
        var setColor = function(c) {
            stopCyclers();
            $.get("/esp", {
                r: c[0],
                g: c[1],
                b: c[2],
                anim: -1,
            });
        };
        var setRemoteCycler = function(id, extra) {
            $.get("/esp", {
                anim: id,
                extra: extra,
            });
        };
        var setRemoteExtra = function(extra) {
            $.get("/esp", {
                extra: extra,
            });
        };
        if (window.colorPicker) {
            colorPicker.setCallback(setColor);
            $.get("/esp", function(rsp) {
                colorPicker.setColor([rsp.r, rsp.g, rsp.b]);
                $('.cycler input').val(rsp.extra);
                toggleCycler(rsp.anim);
            });
        }
        if (window.camera) {
            camera.setCallback(setColor);
        }

        var cyclers = [sinRainbow];

        var stopCyclers = function(except) {
            $('.cycler').removeClass("active");
            for (var i = 0; i < cyclers.length; i++) {
                if (i != except) {
                    cyclers[i].stop();
                }
            }
        };

        var cycler = null;
        var toggleCycler = function(cyclerID) {
            cyclerID = parseInt(cyclerID);
            stopCyclers(cyclerID);
            cycler = cyclers[cyclerID];
            if (!cycler) {
                return;
            }
            var speed = parseInt($('.cycler input').val());
            if (cycler && cycler.toggle(speed)) {
                $('.cycler').addClass("active");
                $('body').css({
                    'background-color': 'transparent'
                });
                setRemoteCycler(cyclerID, speed);
            } else {
                setRemoteCycler(-1);
            }
        };

        $('.cycler').on('click', 'a', function(ev) {
            ev.preventDefault();
            toggleCycler(ev.currentTarget.className);
        });
        $('.cycler').on('change', 'input', _.debounce(function(evt) {
            var speed = parseInt($('.cycler input').val());
            if (cycler) {
                cycler.speed(speed);
            }
            setRemoteExtra(speed);
        }, 100));
    </script>
</body>

</html>
